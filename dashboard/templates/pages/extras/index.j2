{% extends "bases/auth.j2" %}
{% import "./components/icons.j2" as icons %}
{% import "./components/form.j2" as form %}

{% block title %}Extras{% endblock title %}

{% block content %}
<div class="flex flex-col gap-6">
  <div class="breadcrumbs text-sm">
    <ul>
      <li>Dashboard</li>
      <li>Adicionais</li>
    </ul>
  </div>

  <section class="flex gap-2">
    <h1 class="text-2xl">Adicionais</h1>
    <a class="btn btn-primary ml-auto" onclick="create_extra_modal.showModal()">
      Novo
    </a>
  </section>

  <main>
    {% include "./table.j2" %}

    <dialog id="create_extra_modal" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 focus-visible:outline-none">
            {% call icons::xmark() %}
          </button>
        </form>

        <h3 class="text-lg font-bold">Novo adicional</h3>
        <form name="create_extra_form" class="flex flex-col gap-4" enctype="application/x-www-form-urlencoded"
          hx-post="/dashboard/extras">
          {% call form::fields(name = "", price = 0) %}

          <div class="flex items-center justify-between gap-4 mt-3">
            <button type="button" class="btn" onclick="create_extra_modal.close()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Confirmar</button>
          </div>
        </form>
      </div>
    </dialog>
  </main>
</div>
{% endblock content %}

{% block scripts %}
<script type="text/javascript">
  window.onload = () => {
    document.querySelectorAll("td[data-date]")?.forEach(el => {
      el.textContent = new Date(el.textContent).toLocaleDateString('pt-br');
    });

    document.querySelectorAll("td[data-price]")?.forEach(el => {
      const priceCents = Number(el.textContent);
      const priceBrl = Number.isNaN(priceCents) ? 0 : priceCents / 100;
      el.textContent = priceBrl.toLocaleString('pt-br', { style: "currency", currency: 'brl' });
    });

    document.body.addEventListener('htmx:load', function (evt) {
      document.querySelectorAll("input[name=price]")?.forEach(el => {
        el.addEventListener("input", maskBrlOnChange);
      });
    });
  }

  function maskBrlOnChange(ev) {
    const digits = ev.target.value.replace(/\D/g, "");
    const numeric = Number(digits) || 0;
    const cents = Number((numeric / 100).toFixed(2));
    ev.target.value = cents.toLocaleString("pt-br", { style: "currency", currency: "brl" });
  }
</script>
{% endblock scripts %}